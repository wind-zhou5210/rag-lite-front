# 知识库封面图片上传功能技术文档

## 目录

1. [整体架构设计](#1-整体架构设计)
2. [前端实现细节](#2-前端实现细节)
3. [后端实现细节](#3-后端实现细节)
4. [前后端交互协议](#4-前后端交互协议)
5. [安全考虑](#5-安全考虑)
6. [配置管理](#6-配置管理)
7. [扩展性设计](#7-扩展性设计)

---

## 1. 整体架构设计

### 1.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              系统架构总览                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                         前端 (React + Vite)                           │  │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────┐   │  │
│  │  │ ImageUploader   │  │ KnowledgebaseForm│  │ constants.js       │   │  │
│  │  │ (图片上传组件)   │  │ Modal (表单组件) │  │ (前端校验配置)      │   │  │
│  │  └────────┬────────┘  └────────┬────────┘  └─────────────────────┘   │  │
│  │           │                    │                                      │  │
│  │           └────────────────────┼──────────────────────────────────────│  │
│  │                                │                                      │  │
│  │  ┌─────────────────────────────▼─────────────────────────────────┐   │  │
│  │  │                   api/upload.js (API 层)                       │   │  │
│  │  │  • uploadImage(file, bizType, onProgress)                      │   │  │
│  │  │  • getFileUrl(objectKey, expires)                              │   │  │
│  │  └───────────────────────────────────────────────────────────────┘   │  │
│  └──────────────────────────────────│────────────────────────────────────┘  │
│                                     │                                       │
│                          HTTP (multipart/form-data)                         │
│                                     │                                       │
│  ┌──────────────────────────────────▼────────────────────────────────────┐  │
│  │                         后端 (Flask)                                  │  │
│  │  ┌───────────────────────────────────────────────────────────────┐   │  │
│  │  │                  routes/upload.py (路由层)                     │   │  │
│  │  │  • POST /api/upload/image    - 上传图片                        │   │  │
│  │  │  • GET  /api/upload/files/*  - 访问文件(本地存储)              │   │  │
│  │  │  • GET  /api/upload/url      - 获取文件 URL                    │   │  │
│  │  └───────────────────────────────┬───────────────────────────────┘   │  │
│  │                                  │                                    │  │
│  │  ┌───────────────────────────────▼───────────────────────────────┐   │  │
│  │  │              util/file_validator.py (校验层)                   │   │  │
│  │  │  • validate_image_file()     - 综合校验                        │   │  │
│  │  │  • validate_image_extension()- 扩展名校验                      │   │  │
│  │  │  • validate_image_content()  - Magic Number 校验               │   │  │
│  │  │  • sanitize_filename()       - 文件名清理                      │   │  │
│  │  └───────────────────────────────┬───────────────────────────────┘   │  │
│  │                                  │                                    │  │
│  │  ┌───────────────────────────────▼───────────────────────────────┐   │  │
│  │  │             services/storage/ (存储抽象层)                     │   │  │
│  │  │  ┌─────────────────────────────────────────────────────────┐  │   │  │
│  │  │  │           BaseStorageProvider (抽象基类)                │  │   │  │
│  │  │  │  • upload()     • delete()     • get_url()    • exists()│  │   │  │
│  │  │  └─────────────────────┬───────────────┬───────────────────┘  │   │  │
│  │  │                        │               │                       │   │  │
│  │  │          ┌─────────────▼───┐   ┌───────▼─────────────┐        │   │  │
│  │  │          │LocalStorageProvider│ │MinIOStorageProvider │        │   │  │
│  │  │          │   (本地存储)      │ │   (MinIO 存储)       │        │   │  │
│  │  │          └─────────┬────────┘ └────────┬─────────────┘        │   │  │
│  │  └────────────────────┼───────────────────┼──────────────────────┘   │  │
│  └───────────────────────┼───────────────────┼──────────────────────────┘  │
│                          │                   │                              │
│  ┌───────────────────────▼───┐   ┌───────────▼───────────────────────────┐ │
│  │     本地文件系统           │   │              MinIO 服务                │ │
│  │     ./uploads/            │   │     minio:9000 / rag-lite 桶          │ │
│  └───────────────────────────┘   └───────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 数据流向图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            图片上传数据流                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  用户选择图片                                                                │
│       │                                                                     │
│       ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  [1] 前端校验 (ImageUploader.jsx)                                    │   │
│  │      • 文件类型: image/jpeg, image/png, image/gif, image/webp        │   │
│  │      • 文件大小: <= 5MB                                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│       │                                                                     │
│       │ 校验通过                                                            │
│       ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  [2] 创建本地预览                                                    │   │
│  │      URL.createObjectURL(file) → 立即显示预览                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│       │                                                                     │
│       │ 同时开始上传                                                        │
│       ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  [3] 发送 HTTP 请求                                                  │   │
│  │      POST /api/upload/image                                          │   │
│  │      Content-Type: multipart/form-data                               │   │
│  │      Body: { file: <binary>, biz_type: "covers" }                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│       │                                                                     │
│       ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  [4] 后端校验 (file_validator.py)                                    │   │
│  │      • 扩展名校验: .jpg, .jpeg, .png, .gif, .webp                    │   │
│  │      • MIME 类型校验                                                 │   │
│  │      • 文件大小校验: <= 5MB                                          │   │
│  │      • Magic Number 校验 (防止伪装文件)                              │   │
│  │      • 文件名清理 (移除危险字符)                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│       │                                                                     │
│       │ 校验通过                                                            │
│       ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  [5] 存储文件 (StorageProvider)                                      │   │
│  │      • 生成 object_key: covers/2025/01/abc123def456.jpg              │   │
│  │      • 本地存储: 写入 ./uploads/{object_key}                         │   │
│  │      • MinIO: 上传到 rag-lite 桶                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│       │                                                                     │
│       ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  [6] 返回响应                                                        │   │
│  │      {                                                               │   │
│  │        "code": 200,                                                  │   │
│  │        "data": {                                                     │   │
│  │          "object_key": "covers/2025/01/abc123def456.jpg",            │   │
│  │          "url": "http://localhost:5000/api/upload/files/..."         │   │
│  │        }                                                             │   │
│  │      }                                                               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│       │                                                                     │
│       ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  [7] 前端处理响应                                                    │   │
│  │      • 释放本地预览 URL                                              │   │
│  │      • 更新预览为服务器 URL                                          │   │
│  │      • 通过 onChange 回调通知父组件: { objectKey, url }              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.3 图片访问流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            图片访问数据流                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  前端请求知识库列表/详情                                                     │
│       │                                                                     │
│       ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  后端查询数据库                                                      │   │
│  │  SELECT * FROM knowledgebases WHERE user_id = ?                      │   │
│  │  → cover_image = "covers/2025/01/abc123.jpg" (只存 object_key)       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│       │                                                                     │
│       ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  _convert_cover_url() 转换为可访问 URL                               │   │
│  │  调用 storage.get_url(object_key)                                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│       │                                                                     │
│       ├──────────────────────────┬──────────────────────────────────────   │
│       │                          │                                          │
│       ▼ STORAGE_TYPE=local       ▼ STORAGE_TYPE=minio                       │
│  ┌─────────────────────┐   ┌─────────────────────────────────────────┐     │
│  │ 生成 Flask 路由 URL  │   │ 生成 MinIO 预签名 URL                    │     │
│  │ /api/upload/files/   │   │ 包含 X-Amz-Signature                    │     │
│  │ {object_key}         │   │ 有效期: 7 天                            │     │
│  └──────────┬──────────┘   └──────────────────┬──────────────────────┘     │
│             │                                  │                            │
│             ▼                                  ▼                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  返回给前端: cover_image_url                                         │   │
│  │  本地: http://localhost:5000/api/upload/files/covers/2025/01/a.jpg  │   │
│  │  MinIO: http://minio:9000/rag-lite/covers/...?X-Amz-Signature=xxx   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│       │                                                                     │
│       ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  前端 <img src={cover_image_url} />                                  │   │
│  │                                                                      │   │
│  │  本地存储: 浏览器 → Flask → send_file() → 返回图片                   │   │
│  │  MinIO:    浏览器 → MinIO 服务 → 直接返回图片 (不经过 Flask)         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 前端实现细节

### 2.1 ImageUploader 组件设计

**文件位置**: `rag_lite_frontend/src/components/ImageUploader.jsx`

#### 组件接口

```javascript
/**
 * 图片上传组件
 * 
 * @param {Object} props
 * @param {string} props.imageUrl     - 当前图片的访问 URL（用于预览/回显）
 * @param {function} props.onChange   - 值变化回调，参数为 { objectKey, url }
 * @param {string} props.bizType      - 业务类型，默认 'covers'
 * @param {boolean} props.disabled    - 是否禁用
 */
const ImageUploader = ({ imageUrl, onChange, bizType = 'covers', disabled = false })
```

#### 状态管理

```javascript
const [uploading, setUploading] = useState(false);     // 上传状态
const [progress, setProgress] = useState(0);           // 上传进度 (0-100)
const [previewUrl, setPreviewUrl] = useState(imageUrl || '');  // 预览 URL
```

#### 核心流程

```
┌──────────────────────────────────────────────────────────────────┐
│                    ImageUploader 组件流程                         │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. 用户点击/拖拽图片                                             │
│       │                                                          │
│       ▼                                                          │
│  2. beforeUpload(file) 触发                                      │
│       │                                                          │
│       ▼                                                          │
│  3. validateFile(file)                                           │
│     ├─ 校验类型: IMAGE_UPLOAD_CONFIG.allowedTypes                │
│     └─ 校验大小: IMAGE_UPLOAD_CONFIG.maxSize (5MB)               │
│       │                                                          │
│       │ 校验失败 → message.error() → return false                │
│       │                                                          │
│       ▼ 校验通过                                                 │
│  4. 创建本地预览                                                  │
│     URL.createObjectURL(file) → setPreviewUrl()                  │
│     (立即显示，提升用户体验)                                       │
│       │                                                          │
│       ▼                                                          │
│  5. uploadImage(file, bizType, onProgress)                       │
│     └─ 显示上传进度条                                            │
│       │                                                          │
│       │ 上传失败 → 恢复原预览 → message.error()                  │
│       │                                                          │
│       ▼ 上传成功                                                 │
│  6. 处理响应                                                     │
│     ├─ URL.revokeObjectURL() 释放本地预览                        │
│     ├─ setPreviewUrl(response.url) 更新为服务器 URL              │
│     └─ onChange({ objectKey, url }) 通知父组件                   │
│       │                                                          │
│       ▼                                                          │
│  7. message.success('图片上传成功')                               │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

### 2.2 前端校验配置

**文件位置**: `rag_lite_frontend/src/utils/constants.js`

```javascript
export const IMAGE_UPLOAD_CONFIG = {
  maxSize: 5 * 1024 * 1024,  // 5MB
  allowedTypes: ['image/jpeg', 'image/png', 'image/gif', 'image/webp'],
  allowedExtensions: ['.jpg', '.jpeg', '.png', '.gif', '.webp'],
  acceptText: 'JPG, PNG, GIF, WebP',
  maxSizeText: '5MB',
};
```

### 2.3 API 交互层

**文件位置**: `rag_lite_frontend/src/api/upload.js`

```javascript
/**
 * 上传图片
 * @param {File} file       - 图片文件对象
 * @param {string} bizType  - 业务类型（如 'covers'）
 * @param {function} onProgress - 上传进度回调
 * @returns {Promise<{object_key: string, url: string}>}
 */
export const uploadImage = (file, bizType = 'covers', onProgress = null) => {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('biz_type', bizType);
  
  const config = {
    headers: { 'Content-Type': 'multipart/form-data' },
  };
  
  if (onProgress) {
    config.onUploadProgress = (progressEvent) => {
      const percent = Math.round((progressEvent.loaded * 100) / progressEvent.total);
      onProgress(percent);
    };
  }
  
  return api.post('/upload/image', formData, config);
};
```

### 2.4 图片删除处理

组件通过悬浮遮罩层提供删除功能：

```javascript
const handleRemove = useCallback((e) => {
  e.stopPropagation();
  setPreviewUrl('');
  onChange?.({ objectKey: null, url: null });  // 通知父组件清空
}, [onChange]);
```

**注意**: 前端删除只是清除引用，实际图片文件的删除在后端知识库更新/删除时处理。

---

## 3. 后端实现细节

### 3.1 存储层抽象设计

#### 抽象基类 (BaseStorageProvider)

**文件位置**: `rag_lite/app/services/storage/base.py`

```python
class BaseStorageProvider(ABC):
    """存储提供者抽象基类"""
    
    @abstractmethod
    def upload(self, file_data: BinaryIO, filename: str, 
               content_type: str, file_size: int, biz_type: str = "default"
              ) -> Tuple[Optional[str], Optional[str]]:
        """上传文件，返回 (object_key, error)"""
        pass
    
    @abstractmethod
    def delete(self, object_key: str) -> Tuple[bool, Optional[str]]:
        """删除文件，返回 (success, error)"""
        pass
    
    @abstractmethod
    def get_url(self, object_key: str, expires: int = 3600) -> Optional[str]:
        """获取文件访问 URL"""
        pass
    
    @abstractmethod
    def exists(self, object_key: str) -> bool:
        """检查文件是否存在"""
        pass
    
    def generate_object_key(self, filename: str, biz_type: str = "default") -> str:
        """生成唯一的 object_key: {biz_type}/{year}/{month}/{uuid}.{ext}"""
        ...
```

#### object_key 生成规则

```
格式: {biz_type}/{year}/{month}/{uuid16}.{ext}
示例: covers/2025/01/abc123def4567890.jpg

组成部分:
- biz_type: 业务类型 (covers, avatars 等)
- year:     4位年份
- month:    2位月份 (补零)
- uuid16:   16位 UUID 片段 (uuid4().hex[:16])
- ext:      原文件扩展名 (小写)
```

### 3.2 本地存储实现 (LocalStorageProvider)

**文件位置**: `rag_lite/app/services/storage/local_storage.py`

```python
class LocalStorageProvider(BaseStorageProvider):
    """本地存储提供者"""
    
    def __init__(self):
        self.upload_dir = os.path.abspath(Config.LOCAL_UPLOAD_DIR)  # ./uploads
        self._ensure_dir_exists(self.upload_dir)
    
    def upload(self, file_data, filename, content_type, file_size, biz_type="default"):
        object_key = self.generate_object_key(filename, biz_type)
        full_path = os.path.join(self.upload_dir, object_key)
        
        # 确保目录存在
        self._ensure_dir_exists(os.path.dirname(full_path))
        
        # 分块写入文件 (8KB chunks)
        with open(full_path, 'wb') as f:
            while chunk := file_data.read(8192):
                f.write(chunk)
        
        return object_key, None
    
    def get_url(self, object_key, expires=3600):
        """生成 Flask 路由 URL"""
        base_url = request.host_url.rstrip('/')
        return f"{base_url}/api/upload/files/{object_key}"
    
    def delete(self, object_key):
        full_path = os.path.join(self.upload_dir, object_key)
        if os.path.exists(full_path):
            os.remove(full_path)
            self._cleanup_empty_dirs(os.path.dirname(full_path))
        return True, None
```

### 3.3 MinIO 存储实现 (MinIOStorageProvider)

**文件位置**: `rag_lite/app/services/storage/minio_storage.py`

```python
class MinIOStorageProvider(BaseStorageProvider):
    """MinIO 存储提供者"""
    
    def __init__(self):
        from minio import Minio
        self.client = Minio(
            endpoint=Config.MINIO_ENDPOINT,
            access_key=Config.MINIO_ACCESS_KEY,
            secret_key=Config.MINIO_SECRET_KEY,
            secure=Config.MINIO_SECURE
        )
        self.bucket_name = Config.MINIO_BUCKET
        self._ensure_bucket_exists()
    
    def upload(self, file_data, filename, content_type, file_size, biz_type="default"):
        object_key = self.generate_object_key(filename, biz_type)
        self.client.put_object(
            bucket_name=self.bucket_name,
            object_name=object_key,
            data=file_data,
            length=file_size,
            content_type=content_type
        )
        return object_key, None
    
    def get_url(self, object_key, expires=604800):  # 7天有效期
        """生成预签名 URL"""
        return self.client.presigned_get_object(
            bucket_name=self.bucket_name,
            object_name=object_key,
            expires=timedelta(seconds=expires)
        )
    
    def delete(self, object_key):
        self.client.remove_object(self.bucket_name, object_key)
        return True, None
```

### 3.4 存储工厂模式

**文件位置**: `rag_lite/app/services/storage/factory.py`

```python
_storage_provider: Optional[BaseStorageProvider] = None

def get_storage_provider() -> BaseStorageProvider:
    """获取存储提供者实例（单例模式）"""
    global _storage_provider
    
    if _storage_provider is not None:
        return _storage_provider
    
    storage_type = Config.STORAGE_TYPE.lower()
    
    if storage_type == 'local':
        from app.services.storage.local_storage import LocalStorageProvider
        _storage_provider = LocalStorageProvider()
    elif storage_type == 'minio':
        from app.services.storage.minio_storage import MinIOStorageProvider
        _storage_provider = MinIOStorageProvider()
    else:
        raise ValueError(f"不支持的存储类型: {storage_type}")
    
    return _storage_provider
```

### 3.5 文件校验实现

**文件位置**: `rag_lite/app/util/file_validator.py`

#### 校验层次

```
┌─────────────────────────────────────────────────────────────────┐
│                     文件校验四层防护                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  第一层: 扩展名校验                                              │
│  ├─ validate_image_extension(filename)                          │
│  └─ 允许: jpg, jpeg, png, gif, webp                             │
│                                                                 │
│  第二层: MIME 类型校验                                           │
│  ├─ validate_mime_type(content_type)                            │
│  └─ 允许: image/jpeg, image/png, image/gif, image/webp          │
│                                                                 │
│  第三层: 文件大小校验                                            │
│  ├─ validate_image_size(file_size)                              │
│  └─ 最大: 5MB (可配置)                                          │
│                                                                 │
│  第四层: Magic Number 校验 (内容检测)                            │
│  ├─ validate_image_content(header_bytes)                        │
│  └─ 检查文件头部字节签名:                                        │
│     • JPEG: FF D8 FF                                            │
│     • PNG:  89 50 4E 47 0D 0A 1A 0A                             │
│     • GIF:  GIF87a 或 GIF89a                                    │
│     • WebP: RIFF....WEBP                                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 文件名清理

```python
def sanitize_filename(filename: str) -> str:
    """移除危险字符，防止路径注入"""
    dangerous_chars = ['/', '\\', '..', '<', '>', ':', '"', '|', '?', '*', '\x00']
    for char in dangerous_chars:
        name = name.replace(char, '_')
    
    # 限制长度
    if len(name) > 100:
        name = name[:100]
    
    return name + ext.lower()
```

### 3.6 知识库服务集成

**文件位置**: `rag_lite/app/services/knowledgebase_service.py`

#### URL 转换

```python
def _convert_cover_url(self, kb_dict: Dict[str, Any]) -> Dict[str, Any]:
    """将 object_key 转换为可访问 URL"""
    if kb_dict.get('cover_image'):
        storage = get_storage_provider()
        kb_dict['cover_image_url'] = storage.get_url(kb_dict['cover_image'])
    else:
        kb_dict['cover_image_url'] = None
    return kb_dict
```

#### 图片删除时机

```python
def update(self, kb_id, user_id, **update_data):
    image_to_delete = None
    
    with session_scope() as session:
        # ... 更新数据库
        if cover_image_changed:
            image_to_delete = old_cover_image
    
    # 事务提交成功后，再删除旧图片（避免数据不一致）
    if image_to_delete:
        self._delete_cover_image(image_to_delete)
```

---

## 4. 前后端交互协议

### 4.1 API 接口定义

#### 4.1.1 上传图片

```http
POST /api/upload/image
Authorization: Bearer <token>
Content-Type: multipart/form-data

------WebKitFormBoundary
Content-Disposition: form-data; name="file"; filename="cover.jpg"
Content-Type: image/jpeg

<binary data>
------WebKitFormBoundary
Content-Disposition: form-data; name="biz_type"

covers
------WebKitFormBoundary--
```

**成功响应** (200):
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "object_key": "covers/2025/01/abc123def4567890.jpg",
    "url": "http://localhost:5000/api/upload/files/covers/2025/01/abc123def4567890.jpg"
  }
}
```

**失败响应** (400):
```json
{
  "code": 400,
  "message": "不支持的图片格式: .exe，允许的格式: .jpg, .jpeg, .png, .gif, .webp"
}
```

#### 4.1.2 访问文件 (本地存储)

```http
GET /api/upload/files/{object_key}
```

**成功响应**: 返回文件内容，Content-Type 根据扩展名自动设置

**失败响应** (404):
```json
{
  "code": 404,
  "message": "文件不存在"
}
```

#### 4.1.3 获取文件 URL

```http
GET /api/upload/url?object_key=covers/2025/01/abc.jpg&expires=3600
Authorization: Bearer <token>
```

**成功响应** (200):
```json
{
  "code": 200,
  "data": {
    "url": "http://minio:9000/rag-lite/covers/...?X-Amz-Signature=..."
  }
}
```

### 4.2 错误码约定

| HTTP 状态码 | 业务码 | 说明 |
|------------|-------|------|
| 200 | 200 | 成功 |
| 400 | 400 | 请求参数错误（校验失败） |
| 401 | 401 | 未授权（Token 无效/过期） |
| 404 | 404 | 文件不存在 |
| 500 | 500 | 服务器内部错误 |

### 4.3 数据流转图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         完整数据流转过程                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐                                                            │
│  │   前端组件   │                                                            │
│  │ ImageUploader│                                                            │
│  └──────┬──────┘                                                            │
│         │                                                                   │
│         │ 1. 选择文件后                                                     │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ FormData:                                                            │   │
│  │   file: File { name: "photo.jpg", type: "image/jpeg", size: 102400 } │   │
│  │   biz_type: "covers"                                                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         │ 2. HTTP POST (multipart/form-data)                               │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Flask request.files['file']:                                         │   │
│  │   FileStorage {                                                      │   │
│  │     filename: "photo.jpg",                                           │   │
│  │     content_type: "image/jpeg",                                      │   │
│  │     stream: <SpooledTemporaryFile>                                   │   │
│  │   }                                                                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         │ 3. 校验 + 存储后                                                 │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 存储结果:                                                            │   │
│  │   object_key: "covers/2025/01/a1b2c3d4e5f67890.jpg"                  │   │
│  │   存储位置:                                                          │   │
│  │     本地: ./uploads/covers/2025/01/a1b2c3d4e5f67890.jpg              │   │
│  │     MinIO: s3://rag-lite/covers/2025/01/a1b2c3d4e5f67890.jpg         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         │ 4. 生成访问 URL                                                  │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 响应数据:                                                            │   │
│  │   {                                                                  │   │
│  │     "object_key": "covers/2025/01/a1b2c3d4e5f67890.jpg",             │   │
│  │     "url": "http://localhost:5000/api/upload/files/covers/..."       │   │
│  │   }                                                                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         │ 5. 前端接收并回调                                                │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ onChange({ objectKey, url })                                         │   │
│  │   → 父组件保存 objectKey 用于表单提交                                 │   │
│  │   → 组件显示 url 作为预览                                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         │ 6. 创建知识库时                                                  │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 表单提交:                                                            │   │
│  │   {                                                                  │   │
│  │     "name": "测试知识库",                                            │   │
│  │     "cover_image": "covers/2025/01/a1b2c3d4e5f67890.jpg", ← object_key│   │
│  │     "chunk_size": 512,                                               │   │
│  │     "chunk_overlap": 50                                              │   │
│  │   }                                                                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         │ 7. 数据库只存储 object_key                                       │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ DB knowledgebases 表:                                                │   │
│  │   id | name       | cover_image                             | ...    │   │
│  │   1  | 测试知识库  | covers/2025/01/a1b2c3d4e5f67890.jpg     | ...    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 安全考虑

### 5.1 文件类型校验（三重防护）

```
┌─────────────────────────────────────────────────────────────────┐
│                      防止恶意文件上传                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  攻击场景: 攻击者将 malware.exe 重命名为 malware.jpg 上传       │
│                                                                 │
│  防护层:                                                        │
│                                                                 │
│  [1] 扩展名校验 ✓                                               │
│      └─ 只允许 .jpg, .png, .gif, .webp                         │
│      └─ 攻击者可绑过: 改扩展名即可                              │
│                                                                 │
│  [2] MIME 类型校验 ✓                                            │
│      └─ Content-Type 必须是 image/*                            │
│      └─ 攻击者可绑过: 伪造 Content-Type Header                  │
│                                                                 │
│  [3] Magic Number 校验 ✓✓✓ (关键防线)                           │
│      └─ 读取文件前 12 字节，验证文件签名                        │
│      └─ JPEG 必须以 FF D8 FF 开头                              │
│      └─ PNG 必须以 89 50 4E 47 开头                            │
│      └─ 攻击者无法绑过: 需要实际修改文件内容                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 路径遍历防护

**文件位置**: `rag_lite/app/routes/upload.py` 第 103-124 行

```python
# 安全检查：防止路径遍历攻击
import urllib.parse
decoded_key = urllib.parse.unquote(object_key)  # 处理 URL 编码绕过

dangerous_patterns = [
    '..',           # 相对路径遍历: ../../etc/passwd
    '\\',          # Windows 路径: ..\..\..\
    '\x00',        # Null 字节截断: image.jpg%00.exe
]

if (decoded_key.startswith('/') or 
    decoded_key.startswith('\\') or
    (len(decoded_key) >= 2 and decoded_key[1] == ':') or  # Windows: C:\
    any(pattern in decoded_key for pattern in dangerous_patterns)):
    logger.warning(f"检测到可疑的路径访问: {object_key}")
    return not_found("文件不存在")
```

### 5.3 认证授权

```
┌─────────────────────────────────────────────────────────────────┐
│                       API 认证要求                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  需要认证的接口:                                                 │
│  • POST /api/upload/image   - @login_required                   │
│  • GET  /api/upload/url     - @login_required                   │
│                                                                 │
│  公开访问的接口:                                                 │
│  • GET /api/upload/files/*  - 无需认证（图片直接访问）           │
│    └─ 仅本地存储模式启用                                        │
│    └─ MinIO 模式下通过签名 URL 访问，自带认证                   │
│                                                                 │
│  安全说明:                                                       │
│  • object_key 使用 UUID 生成，不可猜测                          │
│  • MinIO URL 7天后自动失效                                      │
│  • 本地存储的 URL 永久有效，但 object_key 难以猜测               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.4 文件名清理

```python
# sanitize_filename() 移除的危险字符
dangerous_chars = [
    '/',      # Unix 路径分隔符
    '\\',     # Windows 路径分隔符
    '..',     # 路径遍历
    '<',      # HTML/XML 注入
    '>',      # HTML/XML 注入
    ':',      # Windows 盘符/NTFS 流
    '"',      # 命令注入
    '|',      # 管道符
    '?',      # 通配符
    '*',      # 通配符
    '\x00',   # Null 字节
]
```

---

## 6. 配置管理

### 6.1 后端配置

**文件位置**: `rag_lite/app/config.py`

```python
class Config:
    # 存储类型: 'local' 或 'minio'
    STORAGE_TYPE = os.environ.get('STORAGE_TYPE', 'local')

    # 本地存储配置
    LOCAL_UPLOAD_DIR = os.environ.get('LOCAL_UPLOAD_DIR', './uploads')

    # MinIO 配置
    MINIO_ENDPOINT = os.environ.get('MINIO_ENDPOINT', 'localhost:9000')
    MINIO_ACCESS_KEY = os.environ.get('MINIO_ACCESS_KEY', '')
    MINIO_SECRET_KEY = os.environ.get('MINIO_SECRET_KEY', '')
    MINIO_BUCKET = os.environ.get('MINIO_BUCKET', 'rag-lite')
    MINIO_SECURE = os.environ.get('MINIO_SECURE', 'false').lower() == 'true'

    # 图片上传限制
    MAX_IMAGE_SIZE = int(os.environ.get('MAX_IMAGE_SIZE', 5242880))  # 5MB
    ALLOWED_IMAGE_EXTENSIONS = {'jpg', 'jpeg', 'png', 'gif', 'webp'}
```

### 6.2 环境变量配置示例

**.env 文件**:

```bash
# 存储配置
STORAGE_TYPE=local              # 开发环境使用本地存储
LOCAL_UPLOAD_DIR=./uploads      # 上传目录

# MinIO 配置（生产环境）
# STORAGE_TYPE=minio
# MINIO_ENDPOINT=minio.example.com:9000
# MINIO_ACCESS_KEY=your-access-key
# MINIO_SECRET_KEY=your-secret-key
# MINIO_BUCKET=rag-lite
# MINIO_SECURE=true

# 图片限制
MAX_IMAGE_SIZE=5242880          # 5MB
```

### 6.3 前端配置

**文件位置**: `rag_lite_frontend/src/utils/constants.js`

```javascript
export const IMAGE_UPLOAD_CONFIG = {
  maxSize: 5 * 1024 * 1024,      // 与后端 MAX_IMAGE_SIZE 一致
  allowedTypes: ['image/jpeg', 'image/png', 'image/gif', 'image/webp'],
  allowedExtensions: ['.jpg', '.jpeg', '.png', '.gif', '.webp'],
  acceptText: 'JPG, PNG, GIF, WebP',
  maxSizeText: '5MB',
};
```

### 6.4 配置一致性要求

| 配置项 | 前端 | 后端 | 说明 |
|-------|------|------|------|
| 最大文件大小 | 5MB | 5MB | 必须一致，前端先拦截 |
| 允许的类型 | image/jpeg, png, gif, webp | jpg, jpeg, png, gif, webp | 前端校验 MIME，后端校验扩展名 |
| API 路径 | /upload/image | /api/upload/image | 前端配置 baseURL 包含 /api |

---

## 7. 扩展性设计

### 7.1 添加新存储类型

以添加阿里云 OSS 存储为例：

**步骤 1**: 创建新的存储提供者类

```python
# rag_lite/app/services/storage/oss_storage.py
from app.services.storage.base import BaseStorageProvider

class OSSStorageProvider(BaseStorageProvider):
    """阿里云 OSS 存储提供者"""
    
    def __init__(self):
        import oss2
        self.auth = oss2.Auth(Config.OSS_ACCESS_KEY, Config.OSS_SECRET_KEY)
        self.bucket = oss2.Bucket(
            self.auth, 
            Config.OSS_ENDPOINT, 
            Config.OSS_BUCKET
        )
    
    def upload(self, file_data, filename, content_type, file_size, biz_type="default"):
        object_key = self.generate_object_key(filename, biz_type)
        self.bucket.put_object(object_key, file_data, headers={
            'Content-Type': content_type
        })
        return object_key, None
    
    def delete(self, object_key):
        self.bucket.delete_object(object_key)
        return True, None
    
    def get_url(self, object_key, expires=604800):
        return self.bucket.sign_url('GET', object_key, expires)
    
    def exists(self, object_key):
        return self.bucket.object_exists(object_key)
```

**步骤 2**: 在工厂中注册

```python
# rag_lite/app/services/storage/factory.py
def get_storage_provider() -> BaseStorageProvider:
    storage_type = Config.STORAGE_TYPE.lower()
    
    if storage_type == 'local':
        from app.services.storage.local_storage import LocalStorageProvider
        _storage_provider = LocalStorageProvider()
    elif storage_type == 'minio':
        from app.services.storage.minio_storage import MinIOStorageProvider
        _storage_provider = MinIOStorageProvider()
    elif storage_type == 'oss':  # 新增
        from app.services.storage.oss_storage import OSSStorageProvider
        _storage_provider = OSSStorageProvider()
    else:
        raise ValueError(f"不支持的存储类型: {storage_type}")
    
    return _storage_provider
```

**步骤 3**: 添加配置

```python
# config.py
OSS_ENDPOINT = os.environ.get('OSS_ENDPOINT', '')
OSS_ACCESS_KEY = os.environ.get('OSS_ACCESS_KEY', '')
OSS_SECRET_KEY = os.environ.get('OSS_SECRET_KEY', '')
OSS_BUCKET = os.environ.get('OSS_BUCKET', '')
```

### 7.2 架构设计优势

```
┌─────────────────────────────────────────────────────────────────┐
│                      存储层抽象优势                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 开闭原则 (OCP)                                               │
│     └─ 对扩展开放：添加新存储只需新增类                          │
│     └─ 对修改关闭：不需要修改现有代码                            │
│                                                                 │
│  2. 依赖倒置 (DIP)                                               │
│     └─ 业务层依赖抽象接口 BaseStorageProvider                   │
│     └─ 不依赖具体实现                                           │
│                                                                 │
│  3. 单例模式                                                     │
│     └─ 存储提供者全局单例，避免重复初始化                        │
│     └─ 可通过 reset_storage_provider() 重置（测试用）            │
│                                                                 │
│  4. 配置驱动                                                     │
│     └─ 通过环境变量切换存储类型                                  │
│     └─ 无需修改代码即可切换存储后端                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 7.3 文件目录结构

```
rag_lite/app/services/storage/
├── __init__.py          # 模块导出
├── base.py              # 抽象基类定义
├── factory.py           # 工厂函数（单例）
├── local_storage.py     # 本地存储实现
├── minio_storage.py     # MinIO 存储实现
└── oss_storage.py       # (可扩展) OSS 存储实现
```

---

## 附录

### A. 相关文件清单

| 层级 | 文件路径 | 说明 |
|------|---------|------|
| 前端组件 | `rag_lite_frontend/src/components/ImageUploader.jsx` | 图片上传组件 |
| 前端组件 | `rag_lite_frontend/src/components/KnowledgebaseFormModal.jsx` | 知识库表单 |
| 前端API | `rag_lite_frontend/src/api/upload.js` | 上传 API 封装 |
| 前端配置 | `rag_lite_frontend/src/utils/constants.js` | 前端常量配置 |
| 后端路由 | `rag_lite/app/routes/upload.py` | 上传路由 |
| 后端校验 | `rag_lite/app/util/file_validator.py` | 文件校验工具 |
| 存储抽象 | `rag_lite/app/services/storage/base.py` | 存储基类 |
| 存储工厂 | `rag_lite/app/services/storage/factory.py` | 工厂函数 |
| 本地存储 | `rag_lite/app/services/storage/local_storage.py` | 本地存储实现 |
| MinIO存储 | `rag_lite/app/services/storage/minio_storage.py` | MinIO 实现 |
| 知识库服务 | `rag_lite/app/services/knowledgebase_service.py` | 业务集成 |
| 后端配置 | `rag_lite/app/config.py` | 配置管理 |

### B. 技术栈版本

| 技术 | 版本 | 用途 |
|------|------|------|
| React | 18.x | 前端框架 |
| Vite | 5.x | 前端构建工具 |
| Ant Design | 5.x | UI 组件库 |
| Axios | 1.x | HTTP 客户端 |
| Flask | 3.x | 后端框架 |
| MinIO Python SDK | 7.x | 对象存储 |
| SQLAlchemy | 2.x | ORM |

---

**文档版本**: 1.0  
**更新日期**: 2025-01-20  
**作者**: RAG Lite 开发团队
